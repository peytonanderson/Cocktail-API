<!DOCTYPE html>
<html lang="en">
<head>
    <title>Cocktail API</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script type="text/babel">
        const cocktails = {
          "Bellini": "3 1/3 oz Sparking Wine, 1 2/3 oz Peach Puree",
          "Black Russian": "1 2/3 oz Vodka, 2/3 oz Coffee Liquer",
          "Screwdriver": "1 2/3 oz Vodka, 3 1/3 oz Orange Juice, 1 slice Orange",
        };

        const parseJSON = (xhr) => {
            if (xhr.response) {
                const obj = JSON.parse(xhr.response);

                if (obj.message) {
                    const p = document.createElement('p');
                    p.textContent = `Message: ${obj.message}`;
                    content.appendChild(p);
                }

                if (xhr.status == 200) {
                  let drinksList;
                  switch (obj.id) {
                      case "getDrink":
                          let text = document.querySelector('#drinkSearchText').innerHTML.toLowerCase();
                          drinksList = document.querySelector('#drinks');
                          drinksList.innerHTML = '';
                          for (let drink in cocktails) {
                            if (drink.toLowerCase().includes(text)) {
                                drinksList.innerHTML += `<h2>${drink}</h2><p>${cocktails[drink]}</p>`;
                            }
                          }
                          break;
                      case "getUserDrink":
                          drinksList = document.querySelector('#userDrinks');
                          drinksList = '';
                          for (let drink in obj.drinks.length) {
                            drinksList.innerHTML += `<h2>${drink}</h2><p>${obj.drinks[drink]}</p>`;
                          }
                          break;
                      case "getRandomDrink":
                          document.querySelector('#mainDrinkName').innerHTML = cocktails[Math.random()].name;
                          document.querySelector('#mainDrinkIngredients').innerHTML = cocktails[Math.random()].ingredients;
                          break;
                  }
                } else if (xhr.status == 201) {
                    let userDrinks = document.querySelector('#userDrinks');
                    userDrinks.innerHTML = '';
                    for (let drink in obj.drinksList) {
                        userDrinks.innerHTML += `<h2>${drink}</h2><p>${obj.drinksList[drink]}</p>`;
                    }
                }
            }
        };

        const handleResponse = (xhr, parseResponse) => {
            switch (xhr.status) {
                case 200: // success
                    console.log("Success");
                    break;
                case 201: // drink created
                    console.log("Create Drink");
                    break;
                case 204: // updated (no response from server)
                    console.log("Updated Drink");
                    break;
                case 400: // bad request
                    console.log("Bad Request");
                    break;
                default: // anything else
                    console.log("Error code not implemented by client");
                    break;
            }

            if (parseResponse) {
              parseJSON(xhr);
            }
        };

        const sendPost = (e, form) => {
            const method = form.getAttribute('method');
            const action = form.getAttribute('action');
            const nameField = form.querySelector('#nameField');
            const ingredientsField = form.querySelector('#ingredientsField');

            const xhr = new XMLHttpRequest();
            xhr.open(method, action);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.onload = () => handleResponse(xhr, true);

            const formData = `name=${nameField.value}&ingredients=${ingredientsField.value}`;

            xhr.send(formData);
            e.preventDefault();

            return false;
        };

        const sendGetOrHead = (e, form) => {
            const method = form.getAttribute('method');
            const action = form.getAttribute('action');
            const userDrinkSearchText = document.querySelector('#userDrinkSearchText');

            const xhr = new XMLHttpRequest();
            xhr.open(method, action);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('Accept', 'application/json');

            if (method === 'get') {
              xhr.onload = () => handleResponse(xhr, true);
            } else {
              xhr.onload = () => handleResponse(xhr, false);
            }

            const formData = `userDrink=${userDrinkSearchText.value}`;

            xhr.send(formData);
            e.preventDefault();

            return false;
        }

        const init = () => {
            const addDrinkForm = document.querySelector('#addDrinkForm');
            const drinkSearchForm = document.querySelector('#drinkSearchForm');
            const randomDrinkForm = document.querySelector('#randomDrinkForm');
            const userDrinkSearchForm = document.querySelector('#userDrinkSearchForm');

            const addDrink = (e) => sendPost(e, addDrinkForm);
            const getDrink = (e) => sendGetOrHead(e, drinkSearchForm);
            const getRandomDrink = (e) => sendGetOrHead(e, randomDrinkForm);
            const getUserDrink = (e) => sendGetOrHead(e, userDrinkSearchForm);

            addDrinkForm.addEventListener('submit', addDrink);
            drinkSearchForm.addEventListener('submit', getDrink);
            randomDrinkForm.addEventListener('submit', getRandomDrink);
            userDrinkSearchForm.addEventListener('submit', getUserDrink);

            // get initial drink list
            for (let drink in cocktails) {
                let drinkName = document.createElement('h3');
                let drinkIngredients = document.createElement('p');

                drinkName.className = "drinkName";
                drinkIngredients.className = "drinkIngredients";
                drinkName.innerHTML = drink;
                drinkIngredients.innerHTML = cocktails[drink];

                document.querySelector('#drinks').appendChild(drinkName);
                document.querySelector('#drinks').appendChild(drinkIngredients);
            }
        };

        window.onload = init;
    </script>
</head>
<body>
    <header>
        <h1 id="title">Cocktail API</h1>
        <form id="addDrinkForm" action="/addUserDrink" method="post">
            <input id="nameField" type="text" placeholder="Drink Name" />
            <input id="ingredientsField" type="text" placeholder="Ingredients" />
            <input type="submit" value="Add Drink" />
        </form>
    </header>
    <div id="flexContainer">
        <div id="fullList" class="flexItems">
            <form id="drinkSearchForm" class="search" action="/getDrink" method="get">
                <input id="drinkSearchText" type="text" placeholder="Drink Name" />
                <input type="submit" value="Search" />
            </form>
            <div id="drinks"></div>
        </div>
        <div id="mainDrink" class="flexItems">
            <h2 id="mainDrinkName"></h2>
            <p id="mainDrinkIngredients"></p>
            <form id="randomDrinkForm" action="/getRandomDrink" method="get">
                <input type="submit" value="Random Drink" />
            </form>
        </div>
        <div id="userList" class="flexItems">
            <form id="userDrinkSearchForm" class="search" action="/getUserDrink" method="get">
                <input id="userDrinkSearchText" type="text" placeholder="Drink Name" />
                <input type="submit" value="Search" />
            </form>
            <div id="userDrinks"><p>No drinks yet</p></div>
        </div>
    </div>
</body>
</html>